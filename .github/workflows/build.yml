name: Build
on:
  push:
    branches: [ "main", "release1x", "release" ]
    tags: [ "v*"]
  pull_request:
    branches: [ "main", "release1x", "release" ]
env:
  OPENTAP_ANSI_COLORS: true
  OPENTAP_NO_UPDATE_CHECK: true
jobs:
  build:
    runs-on:
       group: OpenTAP-SpokeVPC
       labels:  [Linux, X64]
    container: mcr.microsoft.com/dotnet/sdk:8.0
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Fix tags
      if: startsWith(github.ref, 'refs/tags/v')
      run: git fetch -f origin ${{ github.ref }}:${{ github.ref }}
    - name: Caching Signing tools
      uses: actions/cache@v3
      id: cache
      with:
        path: ./*.TapPackage
        key: ${{ runner.os }}-packages-1 }}
    - name: Copy Signing tools
      if: steps.cache.outputs.cache-hit != 'true'
      run: |
        aws s3 cp s3://ks-github-runner-tools/sign.1.3.0.TapPackage ./sign.TapPackage --region eu-central-1
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.S3_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET }}
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore -c Release
    - name: Install Sign
      working-directory: bin/Release
      run: ./tap package install -f -v  ../../sign.TapPackage --no-isolation
    - name: Package Expressions
      working-directory: bin/Release
      run: ./tap package create ../../OpenTap.BasicMixins/package.xml
      env: 
        TAP_SIGN_ADDRESS: ${{ secrets.TAP_SIGN_ADDRESS_INTERNAL }}
        TAP_SIGN_AUTH:  ${{ secrets.TAP_SIGN_AUTH }}
        TAP_SIGN_CERT: ${{ github.workspace }}/sign.cer
        DOTFUSCATOR_LICENSE: ${{ secrets.DOTFUSCATOR_LICENSE }}
    - name: Run Unit Tests
      working-directory: bin/Release
      run: ./tap unit-test run

    - name: Upload binaries
      uses: actions/upload-artifact@v2
      with:
        name: TapPackage
        retention-days: 14
        path: |
          bin/Release/*.TapPackage

  publish:
    environment: packages.opentap.io
    runs-on:
       group: OpenTAP-SpokeVPC
       labels:  [Linux, X64]
    container: mcr.microsoft.com/dotnet/sdk:8.0
    needs: build
    steps:
    - name: Download binaries
      uses: actions/download-artifact@v2
      with:
        name: TapPackage
        path: bin/Release/
    - name: Setup OpenTAP
      uses: opentap/setup-opentap@v1.0
      with:
        version: 9.20.0
        packages: 'Repository Client:beta'
    - name: Publish Packages
      working-directory: bin/Release
      run: |
        tap repo upload --repository http://packages.opentap.io --token ${{ secrets.REPO_TOKEN }} "Basic Mixins".*.TapPackage
      